---
title: "STA 160 Project"
author: "Jessica Padolina"
date: "4/30/2017"
output: html_document
---
Mapping Crimes in Major Cities
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE}
setwd("/Users/Jessica/Documents/Stats Stuff/STA-160")
la_crime = read.csv("la_crime.csv")

#Renaming variables for convenience
names(la_crime)[24]="Location"
names(la_crime)[26]="Coordinates"
```

Subsetting violent and drug-related crimes only

We only want the following crime codes:
{231,230,220,118,622,623,860,840,755,761,235,627,922,110,930,943,753,865,434,910,920,435,436,113,625,122,121,210,815,251,250,236,626,928,756}
These codes are violent crimes, so this list will be called "violent_index"

CLEANING DATA
```{r}
#Subsetting the data to contain violent and drug-related crimes only
library(sqldf)
#Renaming variables for sqldf()
names(la_crime)[8] = "Crime_Code"
names(la_crime)[9] = "Crime_Code_Desc"

#Matching distinct crime codes to their descriptions
s = sqldf("SELECT DISTINCT Crime_Code, Crime_Code_Desc 
          FROM la_crime 
          GROUP BY Crime_Code_Desc")

#Subsetting data by crime codes in the above index
la_violent = sqldf("SELECT * FROM la_crime
                   WHERE Crime_Code IN (231,230,220,118,622,623,860,840,755,761,235,627,922,110,930,943,753,865,434,910,920,435,436,113,625,122,121,210,815,251,250,236,626,928,756)")

attach(la_violent)

#Splitting the Coordinates column into two lat and lon columns (character   matrix)
library(stringr)
latlon = str_split_fixed(Coordinates, " ", 2)
latlon[,1] = gsub("\\(", "", latlon[,1])
latlon[,1] = gsub(",", "", latlon[,1])
latlon[,2] = gsub("\\)", "", latlon[,2])

#Converting to numeric class
latlon = apply(latlon, 2, as.numeric)

#Binding new latlon matrix to la_violent dataframe
la_violent[,c("lat","lon")] <- latlon

attach(la_violent)

#Deleting outliers (too far east of main incidences)
la_violent = subset(la_violent, lon < -118.1)

attach(la_violent)
```

DATA EXPLORATION
Preparing tract boundaries
```{r}
#MAPPING LA CRIME
#See STA 141A Lecture 11 slides
#Loading a s***-ton of packages because I am struggling with this ah why does this take so long to figure out
library(ggmap)
#Did not include ggplot2, as calling ggmap should auto-load it in R.
library(gpclib)
library(maptools)
library(rgdal)
library(rgeos)
library(dplyr)
library(plyr)
library(scales)
library(Cairo)
library(raster)

#Preparing boundary shapefile

#Can't figure out how to map above work. So, new help source: http://www.kevjohnson.org/making-maps-in-r/ (Code "Version 2")

tract2 <- readOGR(dsn = ".", layer = "census2010")
tract2 <- spTransform(x=tract, CRSobj=CRS("+proj=longlat +datum=WGS84"))
tract2 <- fortify(tract2, region = "GEOID10")
#Joining crime_tract and tract2 on tract id's
colnames(tract2)[6] = "GEOID10"
plotdata = left_join(tract2, crime_tract)

p <- ggplot() +
    geom_polygon(data = plotdata, aes(x = long, y = lat, group = group,
        fill = count), color = "black", size = 0.25)
ggsave(p, file = "map1.png", width = 6, height = 4.5, type = "cairo-png")
```

CLEANING DATA
```{r}
#Creating Year column
Year = substr(Date.Occurred, 7, 10)
la_violent["Year"] <- Year
attach(la_violent)

#Subsetting crimes by year
la_2010 = subset(la_violent, Year = "2010")
la_2011 = subset(la_violent, Year = "2011")
la_2012 = subset(la_violent, Year = "2012")
la_2013 = subset(la_violent, Year = "2013")
la_2014 = subset(la_violent, Year = "2014")
la_2015 = subset(la_violent, Year = "2015")
la_2016 = subset(la_violent, Year = "2016")
la_2017 = subset(la_violent, Year = "2017")

#To solve the issue of oversaturation, use of contour plots:

testplot = ggmap(la) + geom_point(color = factor(Area.ID), data = la_2010, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2010) + scale_x_continuous(limits = c(-118.7668, -118.1), expand = c(0,0))
ggmap(la) + geom_point(color = factor(Area.ID), data = la_2011, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2011)
ggmap(la) + geom_point(color = factor(Area.ID), data = la_2012, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2012)
ggmap(la) + geom_point(color = factor(Area.ID), data = la_2013, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2013)
ggmap(la) + geom_point(color = factor(Area.ID), data = la_2014, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2014)
ggmap(la) + geom_point(color = factor(Area.ID), data = la_2015, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2015)
ggmap(la) + geom_point(color = factor(Area.ID), data = la_2016, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2016)
ggmap(la) + geom_point(color = factor(Area.ID), data = la_2017, size = 0.05) + stat_density2d(aes(x = lon, y = lat), data = la_2017)
#scale_x_continuous(limits = c(33.34, 34.31)) + scale_y_continuous(limits = c(-118.86, -117.7196))
#These limits were found using sort(lat) and sort(lon) and finding the mins and maxes that aren't 0.

#Possible next steps:
#Center maps
#Include boundaries, multiple variables per map
#Subset by type of crime
#Do for remaining years
#Color by gender/race of victim (ditch area id)
#Animated plot rather than multiple plots per panel
#Consider distorting map to account for population density (cartogram)
#Finalize exploratory data analysis for LA
#See what patterns you can recognize, continue analysis using that

#Further subsetting by types of violent crime
#Types: 

#To include on animated plot:


```
