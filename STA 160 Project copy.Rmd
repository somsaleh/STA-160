---
title: "STA 160 Project"
author: "Jessica Padolina"
date: "4/30/2017"
output: html_document
---
Mapping Crimes in Major Cities
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE}
setwd("/Users/Jessica/Documents/Stats Stuff/STA-160")
la_crime = read.csv("la_crime.csv")

#Renaming variables for convenience
names(la_crime)[24]="Location"
names(la_crime)[26]="Coordinates"
```

Subsetting violent and drug-related crimes only

We only want the following crime codes:
{231,230,220,118,622,623,860,840,755,761,235,627,922,110,930,943,753,865,434,910,920,435,436,113,625,122,121,210,815,251,250,236,626,928,756}
These codes are violent crimes, so this list will be called "violent_index"

CLEANING DATA
```{r}
#Subsetting the data to contain violent and drug-related crimes only
library(sqldf)
#Renaming variables for sqldf()
names(la_crime)[8] = "Crime_Code"
names(la_crime)[9] = "Crime_Code_Desc"

#Matching distinct crime codes to their descriptions
s = sqldf("SELECT DISTINCT Crime_Code, Crime_Code_Desc 
          FROM la_crime 
          GROUP BY Crime_Code_Desc")

#Subsetting data by crime codes in the above index
la_violent = sqldf("SELECT * FROM la_crime
                   WHERE Crime_Code IN (231,230,220,118,622,623,860,840,755,761,235,627,922,110,930,943,753,865,434,910,920,435,436,113,625,122,121,210,815,251,250,236,626,928,756)")

attach(la_violent)

#Splitting the Coordinates column into two lat and lon columns (character   matrix)
library(stringr)
latlon = str_split_fixed(Coordinates, " ", 2)
latlon[,1] = gsub("\\(", "", latlon[,1])
latlon[,1] = gsub(",", "", latlon[,1])
latlon[,2] = gsub("\\)", "", latlon[,2])

#Converting to numeric class
latlon = apply(latlon, 2, as.numeric)

#Binding new latlon matrix to la_violent dataframe
la_violent[,c("lat","lon")] <- latlon

attach(la_violent)

#Deleting outliers (too far east of main incidences)
la_violent = subset(la_violent, lon < -118.1)

attach(la_violent)

#Creating Year column
Year = substr(Date.Occurred, 7, 10)
la_violent["Year"] <- Year
attach(la_violent)
```

DATA EXPLORATION
Preparing tract boundaries
```{r}
#MAPPING LA CRIME
#See STA 141A Lecture 11 slides
#Loading packages
library(ggmap)
library(rgdal)
library(scales)
library(dplyr)
library(Cairo)

#Preparing boundary shapefile

#Help from: https://stackoverflow.com/questions/29872109/binning-longitude-latitude-labeled-data-by-census-block-id (Code "Version 1")
tract <- readOGR(dsn = ".", layer = "census2010")
tract <- spTransform(x=tract, CRSobj=CRS("+proj=longlat +datum=WGS84"))
#tract <- fortify(tract, region = "GEOID10")

#Subsetting crimes by year
la_2010 = subset(la_violent, Year == "2010")
la_2011 = subset(la_violent, Year == "2011")
la_2012 = subset(la_violent, Year == "2012")
la_2013 = subset(la_violent, Year == "2013")
la_2014 = subset(la_violent, Year == "2014")
la_2015 = subset(la_violent, Year == "2015")
la_2016 = subset(la_violent, Year == "2016")
la_2017 = subset(la_violent, Year == "2017")

#Subsetting data

lonlat <- function(x) {
  y = data.frame(lat = x$lat, lon = x$lon)
  return(y)
}

lonlat.df10 <- lonlat(la_2010)
lonlat.df11 <- lonlat(la_2011)
lonlat.df12 <- lonlat(la_2012)
lonlat.df13 <- lonlat(la_2013)
lonlat.df14 <- lonlat(la_2014)
lonlat.df15 <- lonlat(la_2015)
lonlat.df16 <- lonlat(la_2016)
lonlat.df17 <- lonlat(la_2017)

#Converting data into a spatial points object
spdf <- function(x,y) {
  z = SpatialPointsDataFrame(coords=x[, c("lon", "lat")],
                                  data=y, proj4string=CRS("+proj=longlat +datum=WGS84"))
  return(z)
}

la_spdf10 <- spdf(lonlat.df10, la_2010)
la_spdf11 <- spdf(lonlat.df11, la_2011)
la_spdf12 <- spdf(lonlat.df12, la_2012)
la_spdf13 <- spdf(lonlat.df13, la_2013)
la_spdf14 <- spdf(lonlat.df14, la_2014)
la_spdf15 <- spdf(lonlat.df15, la_2015)
la_spdf16 <- spdf(lonlat.df16, la_2016)
la_spdf17 <- spdf(lonlat.df17, la_2017)

#Adding count column (each row is one crime incident)
spdf.list = list(la_spdf10,la_spdf11,la_spdf12,la_spdf13,la_spdf14,la_spdf15,la_spdf16,la_spdf17)

spdf <- function(x) {
  x@data$count <- 1
  return(x)
}

spdf.list <- lapply(spdf.list, spdf)

#Spatial overlay to identify census polygon in which each crime point falls
la_spdf_tract10 <- over(x=spdf.list[[1]], y=tract)
la_spdf_tract11 <- over(x=spdf.list[[2]], y=tract)
la_spdf_tract12 <- over(x=spdf.list[[3]], y=tract)
la_spdf_tract13 <- over(x=spdf.list[[4]], y=tract)
la_spdf_tract14 <- over(x=spdf.list[[5]], y=tract)
la_spdf_tract15 <- over(x=spdf.list[[6]], y=tract)
la_spdf_tract16 <- over(x=spdf.list[[7]], y=tract)
la_spdf_tract17 <- over(x=spdf.list[[8]], y=tract)

#Reassigning/delisting for ease of use
la_spdf10 = spdf.list[[1]]
la_spdf11 = spdf.list[[2]]
la_spdf12 = spdf.list[[3]]
la_spdf13 = spdf.list[[4]]
la_spdf14 = spdf.list[[5]]
la_spdf15 = spdf.list[[6]]
la_spdf16 = spdf.list[[7]]
la_spdf17 = spdf.list[[8]]

#Adding tract data to crime points
la_spdf10@data <- data.frame(la_spdf10@data, la_spdf_tract10)
la_spdf11@data <- data.frame(la_spdf11@data, la_spdf_tract11)
la_spdf12@data <- data.frame(la_spdf12@data, la_spdf_tract12)
la_spdf13@data <- data.frame(la_spdf13@data, la_spdf_tract13)
la_spdf14@data <- data.frame(la_spdf14@data, la_spdf_tract14)
la_spdf15@data <- data.frame(la_spdf15@data, la_spdf_tract15)
la_spdf16@data <- data.frame(la_spdf16@data, la_spdf_tract16)
la_spdf17@data <- data.frame(la_spdf17@data, la_spdf_tract17)

#Aggregate crimes by tract
agg = function(x) {
  y = aggregate(formula=count~GEOID10, data=x@data, FUN=length)
  return(y)
}

crime_tract10 <- agg(la_spdf10)
crime_tract11 <- agg(la_spdf11)
crime_tract12 <- agg(la_spdf12)
crime_tract13 <- agg(la_spdf13)
crime_tract14 <- agg(la_spdf14)
crime_tract15 <- agg(la_spdf15)
crime_tract16 <- agg(la_spdf16)
crime_tract17 <- agg(la_spdf17)

#Adding Year column to each crime_tract dataframe
year10 <- rep("2010-12-31", length(crime_tract10[,1]))
year11 <- rep("2011-12-31", length(crime_tract11[,1]))
year12 <- rep("2012-12-31", length(crime_tract12[,1]))
year13 <- rep("2013-12-31", length(crime_tract13[,1]))
year14 <- rep("2014-12-31", length(crime_tract14[,1]))
year15 <- rep("2015-12-31", length(crime_tract15[,1]))
year16 <- rep("2016-12-31", length(crime_tract16[,1]))
year17 <- rep("2017-12-31", length(crime_tract17[,1]))

#Binding year columns to crime_tract dataframes
ct10 = cbind(year10, crime_tract10)
ct11 = cbind(year11, crime_tract11)
ct12 = cbind(year12, crime_tract12)
ct13 = cbind(year13, crime_tract13)
ct14 = cbind(year14, crime_tract14)
ct15 = cbind(year15, crime_tract15)
ct16 = cbind(year16, crime_tract16)
ct17 = cbind(year17, crime_tract17)

#Renaming year columns to make them homogenous (for merging purposes)
ct.list <- list(ct10,ct11,ct12,ct13,ct14,ct15,ct16,ct17)

ChangeNames <- function(x) {
    names(x)[1] <- "year"
    return(x)
}
ct.list <- lapply(ct.list, ChangeNames)

#Merging all elements in ct.list
ct = ct.list[[1]]
for (i in 2:length(ct.list)) {
  ct = rbind(ct, ct.list[[i]])
  i = i+1
}

#Sorting ct by Tract ID, then by Year (descending)
ct = sqldf("SELECT * FROM ct ORDER BY GEOID10, year DESC;")
  
#Help source: http://www.kevjohnson.org/making-maps-in-r/
#Joining crime_tract and tract on tract id's
colnames(tract)[6] = "GEOID10"
plotdata = left_join(tract, crime_tract)

#Plotting for 2010
p <- ggplot() +
    geom_polygon(data = plotdata, aes(x = long, y = lat, group = group,
        fill = count), color = "black", size = 0.25)
ggsave(p, file = "map1.png", width = 6, height = 4.5, type = "cairo-png")
```

Plotting LA census tracts on map object
```{r}
library(maptools)
library(RColorBrewer)
CArea = readShapePoly("census2010")
CArea <- spTransform(x=tract, CRSobj=CRS("+proj=longlat +datum=WGS84"))
area.points <- fortify(CArea)
la = get_map("Los Angeles, CA")
ggmap(la)
colors <- brewer.pal(9, "BuGn")
ggmap(la) + geom_polygon(aes(x = long,
                   y = lat,
                   group = group),
               data = area.points,
               color = colors[9],
               fill = colors[6],
               alpha = 0.5) +
  labs(x = "Longitude",
       y = "Latitude")
```

Animating counts of crimes per tract over time
```{r}
#0. Finish making crime_tract dataframes
#1. Add date column to each crime_tract dataframe
#2. Combine all crime_tract dataframes into one yearly_counts dataframe

```

CLEANING DATA
```{r}
#Creating Year column
Year = substr(Date.Occurred, 7, 10)
la_violent["Year"] <- Year
attach(la_violent)

#Possible next steps:
#Center maps
#Include boundaries, multiple variables per map
#Subset by type of crime
#Do for remaining years
#Color by gender/race of victim (ditch area id)
#Animated plot rather than multiple plots per panel
#Consider distorting map to account for population density (cartogram)
#Finalize exploratory data analysis for LA
#See what patterns you can recognize, continue analysis using that

#Further subsetting by types of violent crime
#Types: 

#To include on animated plot:


```
